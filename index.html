<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Multi-User P2P Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
    margin:0; padding:0;
    font-family: Arial, sans-serif;
    background:#111; color:#fff;
    display:flex; flex-direction:column;
    align-items:center; justify-content:flex-start;
    min-height:100vh;
}
#login, #chat {
    margin-top:50px;
    display:flex; flex-direction:column; gap:10px;
}
input, button {
    padding:10px; font-size:16px; border-radius:5px; border:none;
}
button {
    background:#00ff88; color:#000; font-weight:bold; cursor:pointer;
}
#chatArea {
    display:flex; flex-direction:column; gap:5px;
    margin-top:20px; width:90%; max-width:600px;
    height:400px; overflow-y:auto; border:1px solid #00ff88; padding:10px;
    background:#000;
}
.message {
    padding:6px 10px; border-radius:5px;
}
.message.self { background:#00ff88; color:#000; align-self:flex-end; }
.message.other { background:#333; color:#fff; align-self:flex-start; }
#messageInput {
    width:90%; max-width:600px; margin-top:10px; display:flex; gap:5px;
}
#messageInput input { flex:1; }
</style>
</head>
<body>

<div id="login">
    <input type="text" id="name" placeholder="Enter Your Name">
    <input type="text" id="roomId" placeholder="Enter Room ID to join">
    <button id="joinBtn">Join Chat</button>
    <input type="text" id="newRoomId" placeholder="Enter New Room ID to create">
    <button id="createBtn">Create New Chat Room</button>
    <p id="myPeerId">Your Peer ID: -</p>
</div>

<div id="chat" style="display:none;">
    <div id="chatArea"></div>
    <div id="messageInput">
        <input type="text" id="msgText" placeholder="Type a message...">
        <button id="sendBtn">Send</button>
    </div>
</div>

<script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
<script>
let peer, myId, localName;
let connections = {}; // key=peerId, value=conn
let roomIdGlobal = "";

// Initialize Peer
peer = new Peer(undefined, {
    host:'0.peerjs.com',
    port:443,
    secure:true
});

peer.on('open', id => {
    myId = id;
    document.getElementById('myPeerId').textContent = "Your Peer ID: " + id;
});

// Handle incoming connections
peer.on('connection', conn => {
    conn.on('data', data => handleMessage(conn.peer, data));
    connections[conn.peer] = conn;
});

// Send message to all connected peers
function broadcastMessage(msg) {
    for(let pid in connections){
        connections[pid].send(msg);
    }
    addMessage(localName, msg, true);
}

// Display message in chat
function addMessage(name, msg, self=false){
    const chatArea = document.getElementById('chatArea');
    const div = document.createElement('div');
    div.className = 'message ' + (self?'self':'other');
    div.textContent = name + ": " + msg;
    chatArea.appendChild(div);
    chatArea.scrollTop = chatArea.scrollHeight;
}

// Handle incoming message
function handleMessage(peerId, data){
    addMessage(data.name, data.msg, false);
}

// Connect to a peer
function connectToPeer(peerId){
    if(connections[peerId]) return;
    const conn = peer.connect(peerId);
    conn.on('open', () => {
        connections[peerId] = conn;
        console.log("Connected to", peerId);
    });
    conn.on('data', data => handleMessage(conn.peer, data));
}

// Join room logic
function joinRoom(roomId){
    roomIdGlobal = roomId;
    // Try connecting to existing peers in room (simple: user enters known peer IDs)
    // For simplicity, we rely on user sharing first peer IDs manually
    alert("Share your Peer ID with others to join same room!");
    document.getElementById('login').style.display='none';
    document.getElementById('chat').style.display='flex';
}

// Button events
document.getElementById('joinBtn').addEventListener('click', ()=>{
    const name = document.getElementById('name').value.trim();
    const roomId = document.getElementById('roomId').value.trim();
    if(!name || !roomId) return alert("Enter name and room ID!");
    localName = name;
    joinRoom(roomId);
});

document.getElementById('createBtn').addEventListener('click', ()=>{
    const name = document.getElementById('name').value.trim();
    const newRoomId = document.getElementById('newRoomId').value.trim();
    if(!name || !newRoomId) return alert("Enter name and new room ID!");
    localName = name;
    joinRoom(newRoomId);
});

// Send message
document.getElementById('sendBtn').addEventListener('click', ()=>{
    const msgInput = document.getElementById('msgText');
    const msg = msgInput.value.trim();
    if(!msg) return;
    msgInput.value = '';
    broadcastMessage({name:localName, msg});
});
</script>
</body>
</html>
